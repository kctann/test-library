# 002-依賴調整

## 功能名稱
依賴調整

## 功能描述

### Given-When-Then 場景定義

#### 場景1：解決用戶版本鎖定問題
**Given**: 用戶的專案使用Spring Boot 2.7.18與Java 11環境  
**When**: 用戶在自己的專案中引入test-library-core依賴  
**Then**: Library能正常運作，不會因版本衝突或API不相容而失敗，用戶不需要被迫升級Spring Boot版本

#### 場景2：支援多層級測試策略
**Given**: Library需要完整的測試覆蓋，包含內部整合與外部環境驗證  
**When**: 開發者進行Library功能開發與驗證  
**Then**: Core模組提供快速的內部整合測試反饋，Demo模組提供真實環境的整合驗證，兩者職責分明且互補

#### 場景3：實現智能CI管控
**Given**: 開發過程中可能只修改Core或只修改Demo，或者同時修改兩者  
**When**: 開發者提交程式碼到repository  
**Then**: CI系統根據修改的檔案路徑自動觸發對應的測試流程，最佳化CI資源使用並提供快速反饋

## 技術實作設計

### Milestone 1: Library Core依賴管理重構

#### 核心目標
解決Library強制綁定Spring Boot版本的問題，讓用戶可以在任何支援的版本組合下使用Library。

#### 技術策略
1. **移除Parent POM繼承**：不再繼承spring-boot-starter-parent，改用BOM管理
2. **Provided Scope依賴**：將Spring Boot依賴改為provided，讓用戶環境提供
3. **版本相容性檢測**：建立機制檢測和驗證Spring Boot版本相容性
4. **內部整合測試**：專注於Library內部組件的整合測試

#### 實作細節
```xml
<!-- Parent POM 重構前 -->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.2.0</version>
</parent>

<!-- Parent POM 重構後 -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>3.2.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### Milestone 2: Demo模組獨立化設計

#### 核心目標
將Demo模組改造為真實用戶環境的模擬平台，支援多版本驗證和真實環境整合測試。

#### 技術策略
1. **Demo完全獨立**：Demo不再繼承Parent POM，使用自己的Spring Boot版本
2. **多版本測試支援**：建立Maven profiles支援不同Spring Boot版本測試
3. **真實環境整合測試**：Demo承擔用戶環境的整合測試責任
4. **Validation Platform**：Demo同時作為驗證平台和使用範例

#### 實作細節
```xml
<!-- Demo POM 獨立化 -->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.7.18</version> <!-- 可切換測試版本 -->
</parent>

<!-- 明確指定Library版本 -->
<dependency>
    <groupId>com.jamestann</groupId>
    <artifactId>test-library-core</artifactId>
    <version>1.0.0-SNAPSHOT</version>
</dependency>
```

### Milestone 3: 智能CI Workflows設計

#### 核心目標
建立智能化的CI/CD流程，根據程式碼修改路徑自動觸發對應的測試，提高開發效率並最佳化CI資源。

#### 技術策略
1. **路徑觸發機制**：根據修改檔案路徑決定CI觸發範圍
2. **分層CI設計**：Core CI、Demo CI、Full CI分別處理不同測試需求
3. **版本矩陣測試**：建立Java版本×Spring Boot版本的測試矩陣
4. **智能依賴判斷**：Core變更自動觸發Demo驗證

#### 實作細節
```yaml
# 智能路徑觸發
on:
  push:
    paths:
      - 'test-library-core/**'  # 只觸發Core CI
      - 'test-library-demo/**'  # 觸發Demo CI + Core CI
```

## Update code/New code History

### NEW-[002][依賴調整]Parent POM重構策略
- 移除spring-boot-starter-parent繼承關係
- 建立BOM依賴管理機制  
- 保留多Java版本支援profiles
- 新增自定義的Parent POM結構

### NEW-[002][依賴調整]Core依賴Scope調整
- 將Spring Boot核心依賴scope改為provided
- 新增SpringBootVersionDetector版本檢測工具
- 建立版本相容性API設計
- 更新AutoConfiguration支援多版本相容

### NEW-[002][依賴調整]Demo模組完全獨立化
- Demo使用獨立的spring-boot-starter-parent
- 建立多Spring Boot版本測試profiles
- 重新設計Demo的Integration Test策略
- Demo承擔真實環境驗證責任

### NEW-[002][依賴調整]測試責任重新分工
- Core Integration Test：Library內部組件整合測試
- Demo Integration Test：用戶環境真實整合測試
- 建立完整的測試層次架構
- 確保測試覆蓋度和效率平衡

### NEW-[002][依賴調整]智能CI Workflows
- 建立路徑觸發的CI pipeline機制
- 實作Core專用、Demo專用、Full CI流程
- 新增版本矩陣測試支援
- 建立智能依賴關係判斷邏輯

## Update History
無（此為新功能開發）

## 開發里程碑規劃

### M1: Library Core依賴管理重構
專注於解決Library核心的版本綁定問題，建立provided scope依賴管理和版本相容性機制。

### M2: Demo模組獨立化設計  
將Demo改造為獨立的驗證平台，支援多版本測試和真實環境整合驗證。

### M3: 智能CI Workflows設計
建立完整的智能CI/CD流程，實現自動化測試觸發和版本矩陣驗證。